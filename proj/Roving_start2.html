<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <script type="text/javascript" src="jquery-1.9.1.js"></script>
    <link rel="stylesheet" type="text/css" href="css/result-light.css">
    <style type="text/css">
        body {
            background-color: ivory;
        }

        canvas {
            border: 1px solid red;
        }
    </style>
    <title>Roving test by dt1295</title>
    <script src="public/javascripts/socket.io.js"></script>


    <script type='text/javascript'>//<![CDATA[
    var socket = io("127.0.0.1:10000");
    var maxConnections = 2
    var idmap = new Array(maxConnections);

    $(window).load(function () {

        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");

        var canvasOffset = $("#canvas").offset();
        var offsetX = canvasOffset.left;
        var offsetY = canvasOffset.top;
        var roverCount = 1;
// animation variables
        var roverX = [0];
        var roverY = [0];
        var roverDead = [0];
        var mineX = [];
        var mineY = [];
        var mineCount = 0;
        var expX = [];
        var expY = [];
        var expCount = 0;
        var timer;
        var points;
        var currentFrame;
        var selected = 0;
        var background = new Image();
        background.onload = loadBackground();
        var phase = 0;
        var maxMines = 3;
        var maxRovers = 3;
        background.src = "http://i.dailymail.co.uk/i/pix/2012/08/24/article-2192780-14AB3C4C000005DC-62_634x417.jpg";

        function loadBackground() {
            return function () {
                ctx.drawImage(background, 0, 0, 800, 800);
            };
        }

        var mine = new Image();
        mine.onload = loadElement();
        mine.src = "img/mine.png"

        var explosion = new Image();
        explosion.onload = loadElement();
        explosion.src = "http://previews.123rf.com/images/juliarstudio/" +
                "juliarstudio1601/juliarstudio160102472/51730522-Nuclear-explosion-with-dust-Orange-and-red-illustration" +
                "-on-transparent-background-Stock-Vector.jpg";

        var rover = new Image();
//rover.src = "http://files.gamebanana.com/img/ico/sprays/walle_2.png";
//rover.src = "http://img07.deviantart.net/7f73/i/2012/274/6/a/wall_e_cg_render__top__by_agavecactus-d5gjq9e.png";
        rover.src = "http://www.pngmart.com/files/3/Wall-E-Transparent-Background.png";
        var mothershipTop = new Image();
        mothershipTop.src = "img/mothership_top.png";
        var mothershipLeft = new Image();
        mothershipLeft.src = "img/mothership_left.png";
        var mothershipBot = new Image();
        mothershipBot.src = "img/mothership_bot.png";
        var mothershipRight = new Image();
        mothershipRight.onload = loadElement();
        mothershipRight.src = "img/mothership_right.png";


        var hash = window.location.hash;

        // Generate room id
        // ---------------
        if (!hash || hash.length < 2) {
            window.location.href = window.location.href + '#' +
                    (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        }
        var room = window.location.hash;
        console.log("Room id = " + room.toString() )
        document.getElementById('room-id').value = room.toString()
        function loadElement() {
            return function () {
                draw(0, 0, roverCount + 1);
            }
        }


        var roverRight = new Image();
        var roverTop = new Image();
        var roverBot = new Image();
        var roverLeft = new Image();

        roverRight.onload = loadElement();
        roverLeft.onload = loadElement();
        roverTop.onload = loadElement();
        roverBot.onload = loadElement();
        roverRight.src = "img/rover2_right.png";
        roverTop.src = "img/rover2_top.png";
        roverBot.src = "img/rover2_bot.png";
        roverLeft.src = "img/rover2_left.png";
        var roverDirection = [0]; // 0 - right, 1 - top, 2 - left, 3 - bot


        function draw(x, y, i) {
            if (phase == 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(background, 0, 0, 800, 800);
                ctx.drawImage(mothershipRight, 0, 0, 40, 40);
                for (var c = 0; c < mineCount; c++) {
                    ctx.drawImage(mine, mineX[c], mineY[c], 40, 40);
                }
            }
            if (phase == 1) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(background, 0, 0, 800, 800);
                for (var d = 0; d < expCount; d++) {
                    console.log("EXPLOSION!", expX[d], expY[d]);
                    ctx.drawImage(explosion, expX[d], expY[d], 40, 40);
                }
                if (roverX[i] > x) {
                    roverDirection[i] = 2;
                }
                if (roverX[i] < x) {
                    roverDirection[i] = 0;
                }
                if (roverY[i] < y) {
                    roverDirection[i] = 3;
                }
                if (roverY[i] > y) {
                    roverDirection[i] = 1;
                }
                for (var c = 0; c < roverCount; c++) {
                    if (roverDead[c] == 1) {
                        continue;
                    }
                    if (c == i) {
                        ctx.beginPath();
                        //ctx.fillStyle = "skyblue";
                        ctx.strokeStyle = "black";
                        ctx.rect(x, y, 40, 40);
                        //ctx.fill();
                        ctx.stroke();
                        if (i == 0) {
                            if (roverDirection[i] == 0) {
                                ctx.drawImage(mothershipRight, x, y, 40, 40);
                            }
                            if (roverDirection[i] == 1) {
                                ctx.drawImage(mothershipTop, x, y, 40, 40);
                            }
                            if (roverDirection[i] == 2) {
                                ctx.drawImage(mothershipLeft, x, y, 40, 40);
                            }
                            if (roverDirection[i] == 3) {
                                ctx.drawImage(mothershipBot, x, y, 40, 40);
                            }
                            //ctx.drawImage(mothership, x, y, 40, 40);
                        }
                        else {
                            //ctx.drawImage(rover, x, y, 40, 40);
                            if (roverDirection[i] == 0) {
                                ctx.drawImage(roverRight, x + 10, y + 10, 20, 20);
                            }
                            if (roverDirection[i] == 1) {
                                ctx.drawImage(roverTop, x + 10, y + 10, 20, 20);
                            }
                            if (roverDirection[i] == 2) {
                                ctx.drawImage(roverLeft, x + 10, y + 10, 20, 20);
                            }
                            if (roverDirection[i] == 3) {
                                ctx.drawImage(roverBot, x + 10, y + 10, 20, 20);
                            }
                        }
                    }
                    else {
                        ctx.beginPath();
                        if (c == 0) {
                            if (roverDirection[c] == 0) {
                                ctx.drawImage(mothershipRight, roverX[c], roverY[c], 40, 40);
                            }
                            if (roverDirection[c] == 1) {
                                ctx.drawImage(mothershipTop, roverX[c], roverY[c], 40, 40);
                            }
                            if (roverDirection[c] == 2) {
                                ctx.drawImage(mothershipLeft, roverX[c], roverY[c], 40, 40);
                            }
                            if (roverDirection[c] == 3) {
                                ctx.drawImage(mothershipBot, roverX[c], roverY[c], 40, 40);
                            }
                        }
                        else {
                            if (roverDirection[c] == 0) {
                                ctx.drawImage(roverRight, roverX[c] + 10, roverY[c] + 10, 20, 20);
                            }
                            if (roverDirection[c] == 1) {
                                ctx.drawImage(roverTop, roverX[c] + 10, roverY[c] + 10, 20, 20);
                            }
                            if (roverDirection[c] == 2) {
                                ctx.drawImage(roverLeft, roverX[c] + 10, roverY[c] + 10, 20, 20);
                            }
                            if (roverDirection[c] == 3) {
                                ctx.drawImage(roverBot, roverX[c] + 10, roverY[c] + 10, 20, 20);
                            }
                        }
                    }
                }
            }
        }

        function isAdjacent(mX, mY, i) {
            //Checks if mX, mY is adjacent to the rover at i. (right, left, top or bottom)
            if ((roverX[i] + 40 < mX && roverX[i] + 80 > mX && roverY[i] < mY && roverY[i] + 40 > mY) ||
                    (roverX[i] - 40 < mX && roverX[i] > mX && roverY[i] < mY && roverY[i] + 40 > mY) ||
                    (roverX[i] < mX && roverX[i] + 40 > mX && roverY[i] + 40 < mY && roverY[i] + 80 > mY) ||
                    (roverX[i] < mX && roverX[i] + 40 > mX && roverY[i] - 40 < mY && roverY[i] > mY)) {
                return true;
            }
            return false;
        }

        function handleClickPhase0(e) {
            mouseX = parseInt(e.pageX - offsetX);
            mouseY = parseInt(e.pageY - offsetY);
            for (var c = 0; c < mineCount; c++) {
                if (mouseX > mineX[c] && mouseX < mineX[c] + 40
                        && mouseY > mineY[c] && mouseY < mineY[c] + 40) {
                    //Delete this mine!
                    mineX.splice(c, 1);
                    mineY.splice(c, 1);
                    mineCount--;
                    draw(0, 0, roverCount + 1);
                    return;
                }
            }
            xLoc = mouseX - (mouseX % 40);
            yLoc = mouseY - (mouseY % 40);
            if (xLoc == 0 && yLoc == 0) {
                return;
            }
            else {
                mineX.push(xLoc);
                mineY.push(yLoc);
                mineCount++;
                draw(0, 0, roverCount + 1);
                if (mineCount >= maxMines) {
                    phase = 1;
                }
            }
        }

        function handleClickPhase1(e) {
            mouseX = parseInt(e.pageX - offsetX);
            mouseY = parseInt(e.pageY - offsetY);
            for (var c = 0; c < roverCount; c++) {
                if (roverDead[c] == 1) {
                    continue;
                }
                if (mouseX > roverX[c] && mouseX < roverX[c] + 40
                        && mouseY > roverY[c] && mouseY < roverY[c] + 40) {
                    selected = c;
                    draw(roverX[selected], roverY[selected], selected);
                    return;
                }
            }
            //$("#downlog").html("Down: " + mouseX + " / " + mouseY + " selected : " + selected);

            if (roverDead[selected] == 1) {
                return;
            }

            if (isAdjacent(mouseX, mouseY, selected) == true) {
                var xLoc = mouseX - (mouseX % 40);
                var yLoc = mouseY - (mouseY % 40);
                console.log("MineCount: ", mineCount);
                for (var c = 0; c < mineCount; c++) {
                    console.log("Here", xLoc, yLoc, mineX[c], mineY[c]);
                    if (xLoc == mineX[c] && yLoc == mineY[c]) {
                        roverDead[selected] = 1;
                        expX.push(mineX[c]);
                        expY.push(mineY[c]);
                        expCount++;
                        mineX.splice(c, 1);
                        mineY.splice(c, 1);
                        mineCount--;
                        break;
                    }
                }
                draw(xLoc, yLoc, selected);
                roverX[selected] = xLoc;
                roverY[selected] = yLoc;
            }
            //currentFrame = 0;
            //if (roverX[selected] < mouseX && roverX[selected] + 40 > mouseX)  {
            //    points = linePoints(roverX[selected], roverY[selected], roverX[selected], mouseY - (mouseY%40));

            //    $("#downlog1").html("RightClickcase1: <" + mouseX + ", " + mouseY + "><"+ roverX[selected] + ", " + roverY[selected] + "><" + roverX[selected]  + ", "+ (mouseY-(mouseY%40)) + ">" + points.length);

            //    if (points.length == 2) {
            //        animate();
            //    }
            //}
            //else if (roverY[selected] < mouseY && roverY[selected] + 40 > mouseY) {
            //    points = linePoints(roverX[selected], roverY[selected], mouseX - (mouseX%40), roverY[selected]);
            //    $("#downlog1").html("RightClickcase2: <" + mouseX + ", " + mouseY + "><"+ roverX[selected] + ", " + roverY[selected] + "><" +  (mouseX - (mouseX%40)) + ", "+ roverY[selected] + ">" + points.length);

            //    if (points.length == 2) {
            //        animate();
            //    }
            //}

            //else {
            //    $("#downlog1").html("RightClickelse: <" + mouseX + ", " + mouseY + "><"+ roverX[selected] + ", " + roverY[selected] + "><" +  (mouseX - (mouseX%40)) + ", "+ roverY[selected]);

            //}
        }

        function handleRightClick(e) {
            //Spawn rover if adjacent to mothership and if space is empty.
            if (phase == 0) {
                return;
            }
            if (roverCount >= maxRovers) {
                return;
            }
            mouseX = parseInt(e.pageX - offsetX);
            mouseY = parseInt(e.pageY - offsetY);
            for (var c = 0; c < roverCount; c++) {
                if (roverDead[c] == 1) {
                    continue;
                }
                if (mouseX > roverX[c] && mouseX < roverX[c] + 40
                        && mouseY > roverY[c] && mouseY < roverY[c] + 40) {
                    return;
                }
            }
            if (isAdjacent(mouseX, mouseY, 0) == true) {
                var xLoc = mouseX - (mouseX % 40);
                var yLoc = mouseY - (mouseY % 40);
                roverX.push(xLoc);
                roverY.push(yLoc);
                roverCount++;
                roverDead.push(0);
                if (xLoc < roverX[0]) {
                    roverDirection.push(2);
                }
                else if (xLoc > roverX[0]) {
                    roverDirection.push(0);
                }
                else if (yLoc < roverY[0]) {
                    roverDirection.push(1);
                }
                else if (yLoc > roverY[0]) {
                    roverDirection.push(3);
                }
                else {
                    roverDirection.push(0);
                }
                for (var c = 0; c < mineCount; c++) {
                    if (xLoc == mineX[c] && yLoc == mineY[c]) {
                        roverDead[roverCount - 1] = 1;
                        expX.push(mineX[c]);
                        expY.push(mineY[c]);
                        expCount++;
                        mineX.splice(c, 1);
                        mineY.splice(c, 1);
                        mineCount--;
                        break;
                    }
                }

                draw(roverX[selected], roverY[selected], selected);
            }
        }


        $("#canvas").contextmenu(function (e) {
            //if (roverX == 10 || roverX == mouseX) {
            handleRightClick(e);

            $("#test").html("TEST: " + roverX + " / " + mouseX);
            return false;
            //}
        });


        $("#canvas").click(function (f) {
            if (phase == 0) {
                handleClickPhase0(f);
            }
            if (phase == 1) {
                handleClickPhase1(f);
            }
            $("#test1").html("TEST1: " + selected + " / " + mouseX + " / " + mouseY + " / " + roverX + " / " + roverY);

        });


        draw(0, 0, 4);

    });//]]>

    </script>


</head>

<body>
<p>Click to move the rectangle to the mouseclick</p>
<p id="downlog">Down</p>
<p id="downlog1">Rightclick : </p>

<canvas id="canvas" width=800 height=800></canvas>
<p id="test">TEST</p>
<p id="test1">TEST1</p>

<p id="test2">TEST2 in animate</p>
<footer class="footer">
    <div id="pop-over" class="pop-over">
        <p>Paste the room id in this field or ask your opponent to do so.</p>
        <span class="pop-over-close">&times;</span>
    </div>
    <form id="refresh-game-form" class="group" action="/">
        <label for="room-id" class="room-id-label">Room id</label><input type="text" id="room-id" class="room-id">
    </form>
</footer>

</body>

</html>

